FROM docker.io/nixos/nix:latest
RUN echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
RUN nix profile install nixpkgs#gnused nixpkgs#gawk nixpkgs#glibc.bin
# FHS compat: VS Code Remote needs glibc dynamic linker + libstdc++
RUN set -e; \
    B=$(dirname "$(dirname "$(readlink -f "$(command -v ldconfig)")")"); \
    G=$(nix-store -q --references "$B" | while read p; do [ -f "$p/lib/libc.so.6" ] && echo "$p" && break; done); \
    S=$(nix build --no-link --print-out-paths nixpkgs#stdenv.cc.cc.lib | head -1); \
    mkdir -p /lib /lib64 /usr/lib /usr/lib/nix-fhs; \
    for f in "$G"/lib/ld-linux-*; do [ -e "$f" ] && ln -sf "$f" /lib/ && ln -sf "$f" /lib64/; done; \
    ln -sf "$S/lib/libstdc++.so.6" /usr/lib/libstdc++.so.6; \
    ln -sf "$G/lib/libc.so.6" /usr/lib/libc.so.6; \
    for f in "$S"/lib/libstdc++.so*; do [ -e "$f" ] && ln -sf "$f" /usr/lib/nix-fhs/; done
RUN ln -s $(command -v bash) /bin/bash
RUN echo 'dev:x:1000:1000::/home/dev:/bin/bash' >> /etc/passwd && \
    echo 'dev:x:1000:' >> /etc/group && \
    mkdir -p /home/dev/.local/bin /workspace /commandhistory && \
    chown -R 1000:1000 /home/dev /workspace /commandhistory /nix
COPY --chown=1000:1000 flake.nix flake.lock /workspace/
USER 1000:1000
RUN nix develop /workspace --command true
RUN nix print-dev-env /workspace > /home/dev/.nix-devshell.sh
COPY --chown=1000:1000 .devcontainer/bashrc /home/dev/.bashrc
ENV HOME="/home/dev" DEVCONTAINER=true LANG=C.UTF-8
WORKDIR /workspace
CMD ["bash"]

