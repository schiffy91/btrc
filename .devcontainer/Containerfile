FROM nixos/nix:latest

# Nix: enable flakes, single-user mode (no nixbld group in container)
RUN echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf && \
    echo 'sandbox = false' >> /etc/nix/nix.conf && \
    echo 'build-users-group =' >> /etc/nix/nix.conf

# Create non-root user declaratively (nixos/nix has no FHS)
ARG USERNAME=dev
RUN mkdir -p /bin /home/$USERNAME && \
    ln -sf "$(which bash)" /bin/bash && \
    printf 'root:x:0:0:root:/root:/bin/bash\n%s:x:1000:1000::/home/%s:/bin/bash\n' \
      "$USERNAME" "$USERNAME" > /etc/passwd && \
    printf 'root:x:0:\n%s:x:1000:\n' "$USERNAME" > /etc/group && \
    printf 'root:!:::::::\n%s:!:::::::\n' "$USERNAME" > /etc/shadow && \
    chown -R 1000:1000 /home/$USERNAME

# Workspace and history
RUN mkdir -p /workspace /commandhistory && \
    touch /commandhistory/.bash_history && \
    chown -R 1000:1000 /workspace /commandhistory
WORKDIR /workspace

# Pre-build dev shell (largest layer â€” cached across rebuilds)
COPY flake.nix /workspace/
RUN nix develop --command true

# Claude Code (install to /usr/local so it's on PATH outside nix dev shell)
ARG CLAUDE_CODE_VERSION=latest
RUN nix develop --command bash -c \
    "npm config set prefix /usr/local && npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}"
ENV PATH="/usr/local/bin:$PATH"

# Transfer nix ownership to dev user (single-user nix requires owner access)
RUN chown -R 1000:1000 /nix /usr/local

USER $USERNAME
ENV DEVCONTAINER=true

# Auto-enter dev shell on login
RUN printf 'if [[ -z "$IN_NIX_SHELL" && -f /workspace/flake.nix ]] && command -v nix &>/dev/null; then\n  exec nix develop /workspace --command bash\nfi\n' \
    >> /home/$USERNAME/.bashrc
