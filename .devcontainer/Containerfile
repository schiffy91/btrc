FROM nixos/nix:latest AS base

ARG TZ
ENV TZ="${TZ:-America/Los_Angeles}"

# Enable flakes
RUN mkdir -p /etc/nix && \
    echo 'experimental-features = nix-command flakes' > /etc/nix/nix.conf && \
    echo 'sandbox = false' >> /etc/nix/nix.conf

# Create non-root user
ARG USERNAME=dev
RUN nix-env -iA nixpkgs.shadow && \
    useradd -m -s /bin/bash $USERNAME && \
    mkdir -p /etc/sudoers.d && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$USERNAME && \
    chmod 0440 /etc/sudoers.d/$USERNAME

# Persist command history
RUN mkdir -p /commandhistory && \
    touch /commandhistory/.bash_history && \
    chown -R $USERNAME /commandhistory

ENV DEVCONTAINER=true

# Create workspace and config dirs
RUN mkdir -p /workspace /config/claude && \
    chown -R $USERNAME:$USERNAME /workspace /config && \
    ln -sf /config/claude /home/$USERNAME/.claude

WORKDIR /workspace

# Copy flake and pre-build dev shell
COPY --chown=$USERNAME:$USERNAME .devcontainer/flake.nix /workspace/flake.nix
RUN nix develop --command echo "dev shell ready"

# Install Claude Code
ARG CLAUDE_CODE_VERSION=latest
RUN nix-env -iA nixpkgs.nodejs_20 && \
    npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}

USER $USERNAME

# Auto-enter Nix dev shell
RUN echo 'if [[ -z "$IN_NIX_SHELL" ]] && [[ -f /workspace/flake.nix ]] && command -v nix &>/dev/null; then exec nix develop /workspace --command bash; fi' >> /home/$USERNAME/.bashrc
