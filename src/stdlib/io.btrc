/* btrc standard library â€” IO
 * Object-oriented file I/O inspired by Python's open() and file objects.
 */

class File {
    private FILE* handle;
    private string path;
    private string mode;
    private bool is_open;

    public File(string path, string mode = "r") {
        self.path = path;
        self.mode = mode;
        self.handle = fopen(path, mode);
        self.is_open = self.handle != NULL;
    }

    public bool ok() {
        return self.is_open;
    }

    public string read() {
        if (!self.is_open) { return ""; }
        fseek(self.handle, 0, SEEK_END);
        long size = ftell(self.handle);
        fseek(self.handle, 0, SEEK_SET);
        char* buf = (char*)malloc(size + 1);
        fread(buf, 1, size, self.handle);
        buf[size] = '\0';
        return buf;
    }

    public string readLine() {
        if (!self.is_open) { return ""; }
        char buf[4096];
        if (fgets(buf, 4096, self.handle) != NULL) {
            int len = (int)strlen(buf);
            if (len > 0 && buf[len - 1] == '\n') {
                buf[len - 1] = '\0';
            }
            return strdup(buf);
        }
        return "";
    }

    public Vector<string> readLines() {
        Vector<string> lines = [];
        if (!self.is_open) { return lines; }
        char buf[4096];
        while (fgets(buf, 4096, self.handle) != NULL) {
            int len = (int)strlen(buf);
            if (len > 0 && buf[len - 1] == '\n') {
                buf[len - 1] = '\0';
            }
            lines.push(strdup(buf));
        }
        return lines;
    }

    public void setHandle(FILE* h) {
        self.handle = h;
        self.is_open = true;
    }

    public void write(string text) {
        if (!self.is_open) { return; }
        fputs(text, self.handle);
    }

    public void writeLine(string text) {
        if (!self.is_open) { return; }
        fputs(text, self.handle);
        fputc('\n', self.handle);
    }

    public void __del__() {
        self.close();
    }

    public void close() {
        if (self.is_open) {
            /* Don't close handles we don't own (stdout, stderr) */
            if (self.path.len() > 0) {
                fclose(self.handle);
            }
            self.is_open = false;
        }
    }

    public bool eof() {
        if (!self.is_open) { return true; }
        return feof(self.handle) != 0;
    }

    public void flush() {
        if (self.is_open) {
            fflush(self.handle);
        }
    }
}

class Path {
    class bool exists(string path) {
        FILE* f = fopen(path, "r");
        if (f != NULL) {
            fclose(f);
            return true;
        }
        return false;
    }

    class string readAll(string path) {
        var f = File(path, "r");
        if (!f.ok()) { return ""; }
        string content = f.read();
        f.close();
        return content;
    }

    class void writeAll(string path, string content) {
        var f = File(path, "w");
        if (!f.ok()) { return; }
        f.write(content);
        f.close();
    }
}
