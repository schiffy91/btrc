#include <assert.h>
#include <string.h>
#include <stdio.h>

/* Comprehensive test exercising many btrc features together:
   classes, inheritance, generics, static methods, f-strings,
   Map/List operations, operator overloading, nullable, etc. */

class Vec2 {
    public float x;
    public float y;

    public Vec2(float x, float y) {
        self.x = x;
        self.y = y;
    }

    public Vec2 __add__(Vec2 other) {
        return Vec2(self.x + other.x, self.y + other.y);
    }

    public float dot(Vec2 other) {
        return self.x * other.x + self.y * other.y;
    }

    public string toString() {
        return f"({self.x}, {self.y})";
    }
}

class Shape {
    public string name;

    public Shape(string name) {
        self.name = name;
    }

    public float area() {
        return 0.0;
    }
}

class Circle extends Shape {
    public float radius;

    public Circle(float radius) {
        self.name = "circle";
        self.radius = radius;
    }

    public float area() {
        return 3.14159 * self.radius * self.radius;
    }
}

class Rect extends Shape {
    public float w;
    public float h;

    public Rect(float w, float h) {
        self.name = "rect";
        self.w = w;
        self.h = h;
    }

    public float area() {
        return self.w * self.h;
    }
}

class Math {
    class int abs(int x) {
        if (x < 0) { return -x; }
        return x;
    }
    class int max(int a, int b) {
        if (a > b) { return a; }
        return b;
    }
}

int add(int a, int b = 10) {
    return a + b;
}

int main() {
    // --- Vec2 with operator overloading and f-string ---
    var a = Vec2(1.0, 2.0);
    var b = Vec2(3.0, 4.0);
    var c = a + b;
    assert(c.x == 4.0);
    assert(c.y == 6.0);

    float d = a.dot(b);
    assert(d == 11.0);

    // --- Inheritance ---
    var circ = Circle(5.0);
    assert(strcmp(circ.name, "circle") == 0);
    float ca = circ.area();
    // area should be ~78.54
    assert(ca > 78.0 && ca < 79.0);

    var rect = Rect(3.0, 4.0);
    assert(strcmp(rect.name, "rect") == 0);
    assert(rect.area() == 12.0);

    // --- Generic collections ---
    Vector<int> nums = [5, 3, 8, 1, 9, 2];
    nums.sort();
    assert(nums[0] == 1);
    assert(nums[5] == 9);
    assert(nums.indexOf(8) == 4);
    assert(nums.contains(5));
    assert(!nums.contains(99));

    Vector<int> middle = nums.slice(2, 4);
    assert(middle.len == 2);

    // --- Map ---
    Map<string, int> scores = {"alice": 95, "bob": 87, "carol": 92};
    assert(scores.has("alice"));
    assert(scores.get("alice") == 95);
    scores.put("dave", 88);
    assert(scores.len == 4);

    Vector<string> keys = scores.keys();
    assert(keys.len == 4);

    scores.remove("bob");
    assert(scores.len == 3);
    assert(!scores.has("bob"));

    // --- Static methods ---
    assert(Math.abs(-42) == 42);
    assert(Math.max(10, 20) == 20);

    // --- f-string as value ---
    int x = 42;
    string msg = f"The answer is {x}";
    assert(strcmp(msg, "The answer is 42") == 0);

    // --- Nullable (pointer) ---
    int* maybe = null;
    assert(maybe == null);
    int val = 10;
    maybe = &val;
    assert(*maybe == 10);

    // --- Range ---
    int sum = 0;
    for i in range(1, 6) {
        sum = sum + i;
    }
    assert(sum == 15);

    // --- Default params ---
    assert(add(3, 4) == 7);
    assert(add(3) == 13);

    // --- Try/catch ---
    int caught = 0;
    try {
        throw "test error";
    } catch (string e) {
        caught = 1;
    }
    assert(caught == 1);

    // Cleanup
    middle.free();
    nums.free();
    keys.free();
    scores.free();

    print("PASS: test_comprehensive");
    return 0;
}
